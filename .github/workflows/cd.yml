name: CD - Build & Deploy to GKE

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # =============================
    # GCP AUTH
    # =============================
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2

    - name: Install GKE auth plugin
      run: gcloud components install gke-gcloud-auth-plugin --quiet

    - name: Enable GKE auth plugin
      run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

    # =============================
    # BUILD & PUSH IMAGE
    # =============================
    - name: Configure Docker
      run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

    - name: Build Docker Image
      run: |
        docker build \
          -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/mlops-repo/fraud-api:latest .

    - name: Push Docker Image
      run: |
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/mlops-repo/fraud-api:latest

    # =============================
    # DEPLOY TO GKE
    # =============================
    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials mlops-cluster --region us-central1

    - name: Deploy to GKE
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/hpa.yaml

    # =============================
    # WAIT FOR SERVICE
    # =============================
    - name: Wait for LoadBalancer IP
      run: |
        for i in {1..30}; do
          SERVICE_IP=$(kubectl get svc fraud-model-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -n "$SERVICE_IP" ]; then
            echo "SERVICE_IP=$SERVICE_IP" >> $GITHUB_ENV
            exit 0
          fi
          sleep 10
        done
        exit 1

    # =============================
    # CAPTURE HPA BASELINE
    # =============================
    - name: Capture HPA baseline
      run: |
        kubectl get hpa fraud-model-hpa -o json > hpa_before.json
        kubectl get pods -l app=fraud-model -o name | wc -l > pods_before.txt

    # =============================
    # LOAD TEST
    # =============================
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Locust
      run: |
        python -m pip install --upgrade pip
        python -m pip install locust

    - name: Run Locust Load Test
      run: |
        locust \
          -f locustfile.py \
          --host=http://${{ env.SERVICE_IP }} \
          --users 50 \
          --spawn-rate 10 \
          --run-time 1m \
          --headless \
          --csv=locust_report

    # =============================
    # CAPTURE POST-LOAD STATE
    # =============================
    - name: Capture HPA after load
      run: |
        kubectl get hpa fraud-model-hpa -o json > hpa_after.json
        kubectl get pods -l app=fraud-model -o name | wc -l > pods_after.txt
        kubectl describe hpa fraud-model-hpa > hpa_events.txt

    # =============================
    # ASSERT AUTOSCALING
    # =============================
    - name: Assert autoscaling occurred
      run: |
        BEFORE=$(cat pods_before.txt)
        AFTER=$(cat pods_after.txt)

        echo "Pods before load: $BEFORE"
        echo "Pods after load:  $AFTER"

        if [ "$AFTER" -le "$BEFORE" ]; then
          echo "âŒ Autoscaling did NOT occur"
          exit 1
        fi

        echo "âœ… Autoscaling verified"

    # =============================
    # CML REPORT
    # =============================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install CML
      run: npm install -g @dvcorg/cml

    - name: Publish CML Report
      env:
        REPO_TOKEN: ${{ secrets.TOKEN }}
      run: |
        echo "# ðŸš€ Deployment & Load Test Report" > report.md
        echo "" >> report.md

        echo "## ðŸŒ Service Information" >> report.md
        echo "- **Endpoint:** http://${{ env.SERVICE_IP }}" >> report.md
        echo "- **Platform:** Google Kubernetes Engine" >> report.md
        echo "" >> report.md

        NAME=$(jq -r '.metadata.name' hpa_after.json)
        MIN=$(jq -r '.spec.minReplicas' hpa_after.json)
        MAX=$(jq -r '.spec.maxReplicas' hpa_after.json)
        CUR=$(jq -r '.status.currentReplicas' hpa_after.json)
        CPU_T=$(jq -r '.spec.metrics[0].resource.target.averageUtilization' hpa_after.json)
        CPU_C=$(jq -r '.status.currentMetrics[0].resource.current.averageUtilization' hpa_after.json)
        BEFORE=$(cat pods_before.txt)
        AFTER=$(cat pods_after.txt)

        echo "## âš–ï¸ Autoscaling Status (HPA)" >> report.md
        echo "| Metric | Value |" >> report.md
        echo "|--------|-------|" >> report.md
        echo "| Name | $NAME |" >> report.md
        echo "| Min Pods | $MIN |" >> report.md
        echo "| Max Pods | $MAX |" >> report.md
        echo "| Pods Before Load | $BEFORE |" >> report.md
        echo "| Pods After Load | $AFTER |" >> report.md
        echo "| CPU Target (%) | $CPU_T |" >> report.md
        echo "| CPU Current (%) | $CPU_C |" >> report.md
        echo "" >> report.md

        echo "## ðŸ“œ Autoscaling Events" >> report.md
        echo '```' >> report.md
        grep -A5 "Events:" hpa_events.txt >> report.md
        echo '```' >> report.md

        echo "## ðŸ“Š Load Test Summary" >> report.md
        echo "| Metric | Value |" >> report.md
        echo "|--------|-------|" >> report.md
        awk -F',' 'NR==2 {
          printf("| Total Requests | %s |\n", $3);
          printf("| Failed Requests | %s |\n", $4);
          printf("| Req/sec | %.2f |\n", $10);
          printf("| Median Latency (ms) | %s |\n", $5);
          printf("| Avg Latency (ms) | %.2f |\n", $6);
          printf("| Max Latency (ms) | %.2f |\n", $8);
        }' locust_report_stats.csv >> report.md

        cml comment create report.md
